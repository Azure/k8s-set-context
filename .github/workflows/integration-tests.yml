name: Run Integration Tests
on:
  pull_request:
    branches:
      - master
      - "releases/*"
  push:
    branches:
      - master
      - "releases/*"

jobs:
  kubeconfig-method-integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        id: checkout-code
        uses: actions/checkout@v2
      - name: Npm Install and Build
        id: npm-build
        run: |
          npm install
          npm run build
      - name: Set Context
        uses: ./
        with:
          method: kubeconfig
          context: exp-scratch
          kubeconfig: |
            apiVersion: v1
            clusters:
              - cluster:
                  certificate-authority: fake-ca-file
                  server: https://1.2.3.4
                name: development
              - cluster:
                  insecure-skip-tls-verify: true
                  server: https://5.6.7.8
                name: scratch
            contexts:
              - context:
                  cluster: development
                  namespace: frontend
                  user: developer
                name: dev-frontend
              - context:
                  cluster: development
                  namespace: storage
                  user: developer
                name: dev-storage
              - context:
                  cluster: scratch
                  namespace: default
                  user: experimenter
                name: exp-scratch
            current-context: ""
            kind: Config
            preferences: {}
            users:
              - name: developer
                user:
                  client-certificate: fake-cert-file
                  client-key: fake-key-file
              - name: experimenter
                user:
                  password: some-password
                  username: exp
      - name: Vertify Results
        run: |
          echo "$EXPECTED_KC" > /tmp/expected_kc.json
          echo "here"
          DIFF=$(diff <(jq --sort-keys . $KUBECONFIG) <(jq --sort-keys . /tmp/expected_kc.json) -rqiEZbwBd)
          echo "here2"
          echo $DIFF
          if [ "$DIFF" != "" ]; then exit 1; else echo -e "Kubeconfig matches expected"; fi
        env:
          EXPECTED_KC: |
            {
              "kind": "Config",
              "apiVersion": "v1",
              "preferences": {},
              "clusters": [
                  {
                      "name": "development",
                      "cluster": {
                          "server": "https://1.2.3.4",
                          "certificate-authority": "fake-ca-file"
                      }
                  },
                  {
                      "name": "scratch",
                      "cluster": {
                          "server": "https://5.6.7.8",
                          "insecure-skip-tls-verify": true
                      }
                  }
              ],
              "users": [
                  {
                      "name": "developer",
                      "user": {
                          "client-certificate": "fake-cert-file",
                          "client-key": "fake-key-file"
                      }
                  },
                  {
                      "name": "experimenter",
                      "user": {
                          "username": "exp",
                          "password": "some-password"
                      }
                  }
              ],
              "contexts": [
                  {
                      "name": "dev-frontend",
                      "context": {
                          "cluster": "development",
                          "user": "developer",
                          "namespace": "frontend"
                      }
                  },
                  {
                      "name": "dev-storage",
                      "context": {
                          "cluster": "development",
                          "user": "developer",
                          "namespace": "storage"
                      }
                  },
                  {
                      "name": "exp-scratch",
                      "context": {
                          "cluster": "scratch",
                          "user": "experimenter",
                          "namespace": "default"
                      }
                  }
              ],
              "current-context": "dev-frontend"
            }
