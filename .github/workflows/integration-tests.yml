name: Run Integration Tests
on:
  pull_request:
    branches:
      - master
      - "releases/*"
  push:
    branches:
      - master
      - "releases/*"

jobs:
  kubeconfig-method-integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        id: checkout-code
        uses: actions/checkout@v2
      - name: Npm Install and Build
        id: npm-build
        run: |
          npm install
          npm run build
      - name: Set Input and Output Kubeconfig
        id: set-input-output
        run:
          # need to escape spaces for kubeconfig https://github.community/t/set-output-truncates-multiline-strings/16852/3
          echo "::set-output name=input::$(cat $GITHUB_WORKSPACE/tests/integration/input-kubeconfig.yml | sed "s/'\n'/'%0A'/g")"
      - name: Set Context
        uses: ./
        with:
          method: kubeconfig
          kubeconfig: ${{ steps.set-input-output.outputs.input }}
          context: exp-scratch
      - name: Vertify Results
        run: echo $(cat $KUBECONFIG)
